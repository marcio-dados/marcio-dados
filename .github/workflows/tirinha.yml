name: Atualizar Tirinha

on:
  schedule:
    - cron: "0 10 * * *"   # 07:00 America/Sao_Paulo
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: tirinha-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml pillow

      - name: Executar script
        run: |
          python scripts/fetch_tirinha.py

      - name: Verificar se há mudanças relevantes
        id: diff
        shell: bash
        run: |
          set -e
          CHANGED="no"
          git add -N README.md assets/tirinha.jpg || true
          if ! git diff --quiet -- README.md assets/tirinha.jpg; then
            CHANGED="yes"
          fi
          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      - name: Preparar commit na branch fixa (com fetch/rebase e fallback)
        if: steps.diff.outputs.changed == 'yes'
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Se a branch remota existir, traga-a; senão, crie a partir da main
          if git ls-remote --exit-code --heads origin bot/tirinha >/dev/null 2>&1; then
            git fetch origin bot/tirinha:bot/tirinha
            git checkout bot/tirinha
            # Rebase para evitar non-fast-forward
            git rebase origin/bot/tirinha || (echo "Rebase falhou, fazendo merge rápido" && git rebase --abort && git merge --no-edit origin/bot/tirinha)
          else
            git checkout -B bot/tirinha
          fi
          # Adiciona e commita as mudanças
          git add README.md assets/tirinha.jpg
          git commit -m "task: update perfil" || echo "Nada para commitar"
          # Push com fallback se rolar corrida entre jobs
          git push --set-upstream origin bot/tirinha || (
            echo "Push rejeitado (non-fast-forward). Tentando com --force-with-lease..."
            git push --force-with-lease origin bot/tirinha
          )

      - name: Criar/atualizar Pull Request (bot/tirinha → main)
        if: steps.diff.outputs.changed == 'yes'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const head = 'bot/tirinha';
            const base = context.payload.repository.default_branch || 'main';

            // Verifica se já existe PR aberto dessa branch
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${head}`,
              base
            });

            let pr;
            const title = 'update perfil';
            const body = [
              'Atualização automática do bloco de tirinha no README.',
              '- Atualiza `assets/tirinha.jpg`',
              '- Reescreve o trecho entre `<!-- TIRINHA:START -->` e `<!-- TIRINHA:END -->`'
            ].join('\n');

            if (prs.length > 0) {
              pr = prs[0];
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                title,
                body
              });
            } else {
              const { data } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head,
                base,
                title,
                body
              });
              pr = data;
            }

            core.setOutput('number', String(pr.number));

      - name: Auto-approve PR (com PAT de outra conta)
        if: steps.pr.outputs.number && steps.pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'APPROVE',
              body: 'Auto-approve by bot.'
            });
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}

      - name: Merge agora se estiver 'clean' OU habilitar auto-merge
        if: steps.pr.outputs.number && steps.pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);

            // Lê o PR para checar o estado de merge
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const state = pr.mergeable_state; // 'clean' | 'blocked' | 'behind' | 'draft' | 'unstable' etc.
            core.info(`mergeable_state = ${state}`);

            if (state === 'clean') {
              // Nada bloqueia: faz o merge agora
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'   // ou 'merge' | 'rebase'
              });
              core.info(`PR #${prNumber} merged (squash).`);
            } else {
              // Ainda tem bloqueios (checks, review, etc). Liga o auto-merge para quando liberar.
              const query = `
                mutation($id: ID!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $id,
                    mergeMethod: SQUASH
                  }) { clientMutationId }
                }
              `;
              await github.graphql(query, { id: pr.node_id });
              core.info(`Auto-merge habilitado para PR #${prNumber} (aguardando requisitos).`);
            }
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}

